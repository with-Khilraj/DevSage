<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevSage - Forgot Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom glassmorphism and animations */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .animate-fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }

        .animate-slide-up {
            animation: slideUp 0.6s ease-out;
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        .animate-pulse-slow {
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.4;
            }
            50% {
                opacity: 0.8;
            }
        }

        /* Form styles */
        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #4facfe;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Button styles */
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Loading spinner */
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Success state */
        .success-state {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Error states */
        .form-error {
            border-color: #ef4444 !important;
            background: rgba(239, 68, 68, 0.1) !important;
        }

        .error-message {
            color: #fca5a5;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        /* Floating elements */
        .floating-element {
            position: absolute;
            opacity: 0.1;
            pointer-events: none;
        }

        .floating-code {
            font-family: 'Courier New', monospace;
            color: rgba(255, 255, 255, 0.2);
            font-size: 14px;
        }

        /* Email icon animation */
        .email-sent-animation {
            animation: emailSent 2s ease-in-out;
        }

        @keyframes emailSent {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .forgot-container {
                margin: 1rem;
                padding: 2rem 1.5rem;
            }
        }
    </style>
</head>

<body class="gradient-bg flex items-center justify-center p-4">
    <!-- Floating Code Elements -->
    <div class="floating-element top-10 left-10 animate-float floating-code">
        const resetToken = generateToken();
    </div>
    <div class="floating-element top-20 right-20 animate-float floating-code" style="animation-delay: -2s;">
        await sendResetEmail(user.email);
    </div>
    <div class="floating-element bottom-20 left-20 animate-float floating-code" style="animation-delay: -4s;">
        if (tokenValid) { allowReset(); }
    </div>
    <div class="floating-element bottom-10 right-10 animate-float floating-code" style="animation-delay: -1s;">
        // Password recovery flow
    </div>

    <!-- Main Container -->
    <div class="forgot-container glass rounded-3xl p-8 w-full max-w-md animate-slide-up">
        <!-- Initial State: Request Reset -->
        <div id="requestState" class="text-center">
            <!-- Logo and Header -->
            <div class="mb-8 animate-fade-in">
                <div class="bg-gradient-to-r from-blue-500 to-cyan-500 p-4 rounded-2xl inline-block mb-4">
                    <i class="fas fa-key text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Forgot Password?</h1>
                <p class="text-white text-opacity-70">No worries, we'll send you reset instructions</p>
            </div>

            <!-- Reset Form -->
            <form id="forgotForm" class="space-y-6">
                <!-- Email Field -->
                <div class="animate-fade-in" style="animation-delay: 0.1s;">
                    <label for="email" class="block text-sm font-medium text-white mb-2 text-left">
                        Email Address
                    </label>
                    <div class="relative">
                        <input
                            type="email"
                            id="email"
                            name="email"
                            placeholder="Enter your email address"
                            class="form-input w-full px-4 py-3 pl-12 rounded-xl"
                            required
                        >
                        <i class="fas fa-envelope absolute left-4 top-4 text-white text-opacity-60"></i>
                    </div>
                    <div id="email-error" class="error-message hidden"></div>
                    <p class="text-xs text-white text-opacity-60 mt-2 text-left">
                        Enter the email associated with your DevSage account
                    </p>
                </div>

                <!-- Submit Button -->
                <button
                    type="submit"
                    id="resetButton"
                    class="btn-primary w-full py-3 rounded-xl text-white font-medium animate-fade-in"
                    style="animation-delay: 0.2s;"
                >
                    <span id="resetButtonText">Send Reset Instructions</span>
                    <i id="resetSpinner" class="fas fa-spinner spinner ml-2 hidden"></i>
                </button>

                <!-- Error Message -->
                <div id="resetError" class="hidden p-4 bg-red-500 bg-opacity-20 border border-red-500 border-opacity-30 rounded-xl">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                        <span id="resetErrorText" class="text-red-200 text-sm"></span>
                    </div>
                </div>
            </form>

            <!-- Back to Login -->
            <div class="mt-8 animate-fade-in" style="animation-delay: 0.3s;">
                <a href="#" id="backToLogin" class="text-blue-400 hover:text-blue-300 transition-colors text-sm flex items-center justify-center gap-2">
                    <i class="fas fa-arrow-left"></i>
                    Back to Login
                </a>
            </div>
        </div>

        <!-- Success State: Email Sent -->
        <div id="successState" class="text-center hidden">
            <!-- Success Icon -->
            <div class="mb-8 animate-fade-in">
                <div class="success-state p-6 rounded-2xl inline-block mb-4">
                    <i class="fas fa-paper-plane text-white text-4xl email-sent-animation"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Check Your Email</h1>
                <p class="text-white text-opacity-70">We've sent password reset instructions to</p>
                <p id="sentToEmail" class="text-blue-400 font-medium mt-1"></p>
            </div>

            <!-- Instructions -->
            <div class="glass-dark rounded-xl p-6 mb-6 animate-fade-in" style="animation-delay: 0.1s;">
                <h3 class="font-medium text-white mb-4">What's next?</h3>
                <div class="space-y-3 text-sm text-white text-opacity-80 text-left">
                    <div class="flex items-start gap-3">
                        <div class="bg-blue-500 bg-opacity-20 p-1 rounded-full mt-0.5">
                            <i class="fas fa-check text-blue-400 text-xs"></i>
                        </div>
                        <span>Check your email inbox (and spam folder)</span>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="bg-blue-500 bg-opacity-20 p-1 rounded-full mt-0.5">
                            <i class="fas fa-check text-blue-400 text-xs"></i>
                        </div>
                        <span>Click the reset link in the email</span>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="bg-blue-500 bg-opacity-20 p-1 rounded-full mt-0.5">
                            <i class="fas fa-check text-blue-400 text-xs"></i>
                        </div>
                        <span>Create a new secure password</span>
                    </div>
                </div>
            </div>

            <!-- Resend and Back Options -->
            <div class="space-y-4 animate-fade-in" style="animation-delay: 0.2s;">
                <p class="text-white text-opacity-60 text-sm">
                    Didn't receive the email?
                </p>
                <div class="flex gap-3">
                    <button
                        id="resendButton"
                        class="btn-secondary flex-1 py-3 rounded-xl text-white font-medium"
                    >
                        <span id="resendButtonText">Resend Email</span>
                        <i id="resendSpinner" class="fas fa-spinner spinner ml-2 hidden"></i>
                    </button>
                    <button
                        id="tryDifferentEmail"
                        class="btn-secondary flex-1 py-3 rounded-xl text-white font-medium"
                    >
                        Try Different Email
                    </button>
                </div>
            </div>

            <!-- Back to Login -->
            <div class="mt-8 animate-fade-in" style="animation-delay: 0.3s;">
                <a href="#" id="backToLoginSuccess" class="text-blue-400 hover:text-blue-300 transition-colors text-sm flex items-center justify-center gap-2">
                    <i class="fas fa-arrow-left"></i>
                    Back to Login
                </a>
            </div>
        </div>

        <!-- Rate Limit State -->
        <div id="rateLimitState" class="text-center hidden">
            <div class="mb-8 animate-fade-in">
                <div class="bg-yellow-500 bg-opacity-20 p-6 rounded-2xl inline-block mb-4">
                    <i class="fas fa-clock text-yellow-400 text-4xl animate-pulse-slow"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Too Many Requests</h1>
                <p class="text-white text-opacity-70">Please wait before requesting another reset</p>
            </div>

            <!-- Countdown Timer -->
            <div class="glass-dark rounded-xl p-6 mb-6 animate-fade-in" style="animation-delay: 0.1s;">
                <h3 class="font-medium text-white mb-4">Try again in</h3>
                <div class="text-4xl font-bold text-yellow-400" id="countdown">05:00</div>
                <p class="text-sm text-white text-opacity-60 mt-2">
                    This helps protect your account from abuse
                </p>
            </div>

            <!-- Back to Login -->
            <div class="mt-8 animate-fade-in" style="animation-delay: 0.2s;">
                <a href="#" id="backToLoginRateLimit" class="text-blue-400 hover:text-blue-300 transition-colors text-sm flex items-center justify-center gap-2">
                    <i class="fas fa-arrow-left"></i>
                    Back to Login
                </a>
            </div>
        </div>

        <!-- Help Section -->
        <div class="mt-8 text-center animate-fade-in" style="animation-delay: 0.4s;">
            <p class="text-white text-opacity-50 text-sm">
                <i class="fas fa-question-circle mr-2"></i>
                Need help? <a href="#" class="text-blue-400 hover:text-blue-300">Contact Support</a>
            </p>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Form elements
        const forgotForm = document.getElementById('forgotForm');
        const emailInput = document.getElementById('email');
        const resetButton = document.getElementById('resetButton');
        const resetButtonText = document.getElementById('resetButtonText');
        const resetSpinner = document.getElementById('resetSpinner');
        const resetError = document.getElementById('resetError');
        const resetErrorText = document.getElementById('resetErrorText');

        // State elements
        const requestState = document.getElementById('requestState');
        const successState = document.getElementById('successState');
        const rateLimitState = document.getElementById('rateLimitState');
        const sentToEmail = document.getElementById('sentToEmail');

        // Resend elements
        const resendButton = document.getElementById('resendButton');
        const resendButtonText = document.getElementById('resendButtonText');
        const resendSpinner = document.getElementById('resendSpinner');

        // Rate limiting
        let rateLimitEndTime = null;
        let countdownInterval = null;

        // Form validation
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + '-error');
            
            field.classList.add('form-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + '-error');
            
            field.classList.remove('form-error');
            errorDiv.classList.add('hidden');
        }

        function showResetError(message) {
            resetErrorText.textContent = message;
            resetError.classList.remove('hidden');
        }

        function hideResetError() {
            resetError.classList.add('hidden');
        }

        // Real-time validation
        emailInput.addEventListener('input', function() {
            if (this.value && !validateEmail(this.value)) {
                showFieldError('email', 'Please enter a valid email address');
            } else if (this.value) {
                clearFieldError('email');
            }
        });

        // Form submission
        forgotForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = emailInput.value.trim();
            
            // Clear previous errors
            hideResetError();
            clearFieldError('email');
            
            // Validate email
            if (!email) {
                showFieldError('email', 'Email is required');
                return;
            }
            
            if (!validateEmail(email)) {
                showFieldError('email', 'Please enter a valid email address');
                return;
            }
            
            // Show loading state
            resetButton.disabled = true;
            resetButtonText.textContent = 'Sending Instructions...';
            resetSpinner.classList.remove('hidden');
            
            try {
                // Simulate API call
                await simulatePasswordReset(email);
                
                // Show success state
                showSuccessState(email);
                
            } catch (error) {
                if (error.type === 'rate_limit') {
                    showRateLimitState(error.retryAfter);
                } else {
                    showResetError(error.message);
                    
                    // Reset button
                    resetButton.disabled = false;
                    resetButtonText.textContent = 'Send Reset Instructions';
                    resetSpinner.classList.add('hidden');
                }
            }
        });

        // Simulate password reset API call
        async function simulatePasswordReset(email) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    // Simulate different scenarios
                    if (email === 'ratelimit@test.com') {
                        reject({ 
                            type: 'rate_limit', 
                            message: 'Too many reset attempts', 
                            retryAfter: 300 // 5 minutes
                        });
                    } else if (email === 'notfound@test.com') {
                        reject({ 
                            type: 'not_found', 
                            message: 'No account found with this email address. Please check your email or sign up for a new account.' 
                        });
                    } else {
                        resolve({ success: true });
                    }
                }, 2000);
            });
        }

        // Show success state
        function showSuccessState(email) {
            requestState.classList.add('hidden');
            successState.classList.remove('hidden');
            sentToEmail.textContent = email;
        }

        // Show rate limit state
        function showRateLimitState(retryAfterSeconds) {
            requestState.classList.add('hidden');
            rateLimitState.classList.remove('hidden');
            
            rateLimitEndTime = Date.now() + (retryAfterSeconds * 1000);
            startCountdown();
        }

        // Countdown timer
        function startCountdown() {
            const countdownElement = document.getElementById('countdown');
            
            countdownInterval = setInterval(() => {
                const now = Date.now();
                const timeLeft = Math.max(0, rateLimitEndTime - now);
                
                if (timeLeft === 0) {
                    clearInterval(countdownInterval);
                    // Return to request state
                    rateLimitState.classList.add('hidden');
                    requestState.classList.remove('hidden');
                    
                    // Reset form
                    resetButton.disabled = false;
                    resetButtonText.textContent = 'Send Reset Instructions';
                    resetSpinner.classList.add('hidden');
                    return;
                }
                
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Resend functionality
        resendButton.addEventListener('click', async function() {
            const email = sentToEmail.textContent;
            
            // Show loading state
            resendButton.disabled = true;
            resendButtonText.textContent = 'Resending...';
            resendSpinner.classList.remove('hidden');
            
            try {
                // Simulate resend API call
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Show success feedback
                resendButtonText.textContent = 'Email Sent!';
                resendSpinner.classList.add('hidden');
                resendButton.classList.remove('btn-secondary');
                resendButton.classList.add('bg-green-500');
                
                setTimeout(() => {
                    resendButton.disabled = false;
                    resendButtonText.textContent = 'Resend Email';
                    resendButton.classList.add('btn-secondary');
                    resendButton.classList.remove('bg-green-500');
                }, 3000);
                
            } catch (error) {
                // Reset button on error
                resendButton.disabled = false;
                resendButtonText.textContent = 'Resend Email';
                resendSpinner.classList.add('hidden');
            }
        });

        // Try different email
        document.getElementById('tryDifferentEmail').addEventListener('click', function() {
            successState.classList.add('hidden');
            requestState.classList.remove('hidden');
            emailInput.value = '';
            emailInput.focus();
        });

        // Back to login links
        document.getElementById('backToLogin').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = '/login';
        });

        document.getElementById('backToLoginSuccess').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = '/login';
        });

        document.getElementById('backToLoginRateLimit').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = '/login';
        });

        // Auto-focus email input
        document.addEventListener('DOMContentLoaded', function() {
            emailInput.focus();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Escape to go back to login
            if (e.key === 'Escape') {
                window.location.href = '/login';
            }
        });

        // Demo scenarios
        console.log('Demo scenarios:');
        console.log('- Use "ratelimit@test.com" to see rate limiting');
        console.log('- Use "notfound@test.com" to see account not found error');
        console.log('- Use any other valid email to see success flow');
    </script>
</body>

</html>